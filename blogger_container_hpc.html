<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<HTML>

<HEAD>
		<!-- DataTables jQuery -->
        <meta http-equiv="Content-type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-1.12.0.min.js">
        </script>
        <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.min.js">
        </script>
        <script type="text/javascript" class="init">
         $(document).ready(function() {
          $('table.display').DataTable( {       // multi table example use table.display as selector
            lengthMenu: [ [ 5, 10, 15, 20, -1 ], [ 5, 10, 15, 20, "All" ] ],        // all is coded as -1, thus the double array
            pageLength: -1,                     // YES, can use -1 to display all rows by default
            order: [ ]                          // ie no ordering, show data as they are loaded
            //order: [ 0, "desc" ],             // descending order https://datatables.net/reference/option/order
          } );
         } );
        </script>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.11/css/jquery.dataTables.min.css">  
        <!-- overwrite some css to my liking -->
        <STYLE>
                H1, H2, H3, H4 {
                        /*color: green;*/
                        padding:        0.1em;
                        margin-top:     0.2em;
                        margin-bottom:  0.4em;
                        font-family: helvetica, arial, lucida, sans-serif;
                        /*text-align:     center;*/
                }
                H1 {
                        text-align:     center;
                        background-color: #CCCCCC; /* #BBF0BB; */
                        font-size:      170%;
                        font-weight:    bolder;
                        text-transform: uppercase;
                        ; list-style-type: decimal
                }
                H2 {
                        background-color:       #D0F0D0;
                        font-size:              150%;
                        font-variant:           small-caps;
                        text-transform:         uppercase;
                        border-style:           solid;
                        /* text-transform:      capitalize; */
                        ; list-style-type: decimal
                }
                a:link{     color: green;  text-decoration: underline;  }
                a:visited{  color: gray;   text-decoration: underline;    font-weight: bold;  }
                a:hover{    color: Red;    text-decoration: underline;    background-color: #BBF0BB }  
                /* a:active{   color: Olive;  text-decoration: overline;     background-color: #334433 } */
                table.dataTable tbody td{padding:1px 1px 1px 1px;}
                /* table.dataTable.hover tbody tr:hover { background: cyan; }  don't work */
                /* table.dataTable tbody td:hover { background: magenta; }  this one works but don't like it */
				
				
				table {
				  width: 100%;
				  background-color: #ffffff;
				  border-collapse: collapse;
				  border-width: 1px;
				  border-color: #a4a4a4;
				  border-style: solid;
				  color: #000000;
				}

				table td, table th {
				  border-width: 1px;
				  border-color: #a4a4a4;
				  border-style: solid;
				  padding: 3px;
				}

				table thead, table tfoot {
				  background-color: #CCCCCC; /*#BBF0BB;  ;*/
				}
				
        </STYLE>
</HEAD>


<BODY>
<title>Docker vs Singularity vs Shifter vs UGE Container Edition</title>
<h1>Docker vs Singularity vs Shifter vs UGE Container Edition</h1>


<!-- ################################################################## -->
<!-- ################################################################## -->
<!-- content below can go to blogger, sans tailing /body and /html tags -->

<div dir="ltr" style="text-align: left;" trbidi="on">


This is work in progress.  It helps me understanding whether to adopt Singularity or Shifter.  Please comment on the 
<A HREF="http://geekyap.blogspot.com/2016/11/docker-vs-singularity-vs-shifter-in-hpc.html">blogger comment section</A> 
to improve the doc.  Much thanks!
<BR/>
<!-- CSS Code: Place this code in the document's head (between the 'head' tags) -->
<!--
<style>
table.display {
  width: 100%;
  background-color: #ffffff;
  border-collapse: collapse;
  border-width: 2px;
  border-color: #00a400;
  border-style: solid;
  color: #000000;
}

table.display td, table.display th {
  border-width: 2px;
  border-color: #00a400;
  border-style: solid;
  padding: 3px;
}

table.display thead, table.display tfoot {
  background-color: #00a400; 
}
</style>
-->

<!-- HTML Code: Place this code in the document's body (between the 'body' tags) where the table should appear -->
<br />
<!--table class="GeneratedTable"-->
<table class="display">
<thead>
	<tr>
      <th></th>
      <th>Docker</th>
      <th>Singularity</th>
      <th>Shifter</th>
	  <th>UGE Container Ed.</th>
    </tr>
</thead>
<tfoot>
	<tr>
      <th></th>
      <th>Docker</th>
      <th>Singularity</th>
      <th>Shifter</th>
	  <th>UGE Container Ed.</th>
    </tr>
</tfoot>


<tbody>

<tr>
      <td>Version</td>
      <td>1.15-1</td>
      <td>2.2</td>
      <td>16.08.3</td>
	  <td>8</td>
</tr>
	
	
<tr>
    <td>Host OS</td>
    <td>
    Linux kernel 3.10+, eg: <BR />
		RHEL 7 <br />
		Debian 8.0 <BR />
    Ubuntu 12.04<br />
	  SUSE Linux Enterprise 12<br />
    <A HREF="https://docs.docker.com/engine/installation/linux/">other</A>
    </td>
    <td>
		RHEL 6<BR />
		Ubuntu <br />
		...<BR />
	</td>
    <td>
		Cray OS<BR />
		Linux with kernel 2.6.25+, eg <BR />
    RHEL 6. <BR /> 
        ...<BR />
	</td>
    <td>
		RHEL 7<BR />
		Newer version of Linux that  supports Docker/cgroup. 
	</td>
</tr>


<tr>
      <td>Process isolation via Kernel Namespace?</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Yes</td>
	  <td></td>
</tr>


<tr>
      <td>Resource restriction via cgroup?</td>
      <td></td>
      <td>?</td>
      <td></td>
	  <td>  Define in scheduler config?</td>
</tr>


<tr>
      <td>User management</td>
      <td>?</td>
      <td>Yes.  Container has sanitized passwd, group files</td>
      <td></td>
	  <td></td>
</tr>


<tr>
      <td>Run different OS</td>
      <td>Yes</td>
      <td>Yes</td>
      <td>Yes</td>
      <td></td>
</tr>


<tr>
    <td>User group of primary focus</td>
    <td>Developers/DevOps</td>
    <td>Scientific Application Users</td>
    <td>Slurm admins, docker users</td>
	<td>UGE users</td>
</tr>


<tr>
    <td>Main Problem being addressed</td>
    <td>DevOps, microservices.  Enterprise applications</td>
    <td>Application portability (single image file, this become an executable) <BR>
		Reproducibility and portability (once app stack is build on Singularity).<BR>
		Support for legacy apps/OS.</td>
    <td>Utilize the large number of docker apps.  Provides a way to run them in HPC after a conversion process.  It also strip out all the requirements of root so that they are runnable as user process.  <BR />
    </td>
	<td>Running dockers verbatim in HPC, with UGE managing the docker daemon process (?) </td>
</tr>


<tr>
    <td>Potential Cons?</td>
    <td>Not easily adoptable in HPC environment</td>
    <td>All dependencies in a single image file -> Requires large storage space?  Docker allowed small update if lower stack images remained the same</td>
    <td>While live docker images are editable, it requires root.  Shifter sanitazed the root requirements, so its containers are immutable</td>
	<td>User need elevated priviledges to start containers ? </td>
</tr>



<tr>
      <td>MPI</td>
      <td>
          MP-what? :-)<BR />
      </td>
      <td> 
      Singularity has build-in support for openMPI.  <BR />
		Once app is build with OpenMPI libraries, execute mpirun as normal, replacing the usual binary with the single file singularity app.  <BR />
		While the app is running inside the singularity container, Process Management Interface (PMI) calls will pass thru the singularity launcher onto ORTED. <BR />
	  </td>
      <td>Shifter relies on MPICH Application Binary Interface (ABI).  <BR />
      Apps that use vanilla MPI that is compatibile with MPICH would work.  Site-specific MPI libraries need to be copied to the container at run time.  LD_LIBRARY_PATH need to include for example /opt/udiImage/...  
      </td>
	  <td></td>
</tr>

<tr>
    <td>IB</td>
    <td></td>
	  <td>Native access</td>
    <td></td>
    <td></td>
</tr>

<tr>
      <td>GPU/Phi</td>
      <td>Your app should run head-less, why you trying to access video card? :-)</td>
      <td>Native access, native speed.</td>
      <td>In progress.  Reportedly getting near native performance</td>
	  <td></td>
</tr>



<tr>
      <td>Scheduler</td>
      <td><A HREF="https://docs.docker.com/swarm/overview/">Docker Swarm</A></td>
      <td>Agnostic, run singularity as a job</td>
      <td>Can work as stand alone container environment.  For scalability, scheduler integration currently exist for SLURM, via SPANK plugin.  (Should work with other scheduler) </td>
	  <td></td>
</tr>

<tr>
    <td>Run on multiple nodes?</td>
    <td>Swarm tool provided by Docker</td>
    <td>Scheduler's job to spin multiple instances on multiple nodes</td>
    <td>Yes.  <BR/>
	<TT>
	salloc -N4 ... <BR />srun ... 
	<TT>
    </td>	
    <td></td>
</tr>

<tr>
      <td>Portability</td>
      <td>Docker Hub<BR></td>
      <td>Single image file.  Container purpose build for singularity.  Working to accept docker file or Rocket definition</td>
      <td>Image Gateway pulls from Docker Hub, automatically convert to shifter image.  </td>
	  <td></td>
</tr>





<tr>
      <td>Container activation</td>
      <td>Docker daemon running on each host</td>
      <td>loopback mount on singularity image file to utilize container</td>
      <td>No docker daemon on CN. srun ... loopback mount </td>
	  <td></td>
</tr>


<tr>
    <td>Deployment</td>
    <td></td>
    <td>
		Single .rpm/.deb (in all nodes?) <BR>
		No scheduler modification needed.
	</td>
    <td>
		Shifter need to be installed in all hpc nodes <BR />
    Docker NOT needed in hpc <BR />
    Need an ImageGateway <BR />
	</td>
    <td>
		Upgrade to new version of UGE <BR>
		Head and compute nodes need to be newer version of Linux that supports Docker (eg RHEL 7).
	</td>
	
	</tr>


<tr>
      <td>Security</td>
      <td>
		User running docker commands need to be in special docker group to gain elevated system access <BR>
	  </td>
      <td>
		No change in security paradigm.<BR>
		User run singularity image/app without special privileges.  
	  </td>
      <td>
		root to install shifter binary.  <BR>
		Need special integration into scheduler.<BR>
		User run shifter image/app without special privileges.  <BR>
	  </td>
	  <td></td>
</tr>


<tr>
      <td>Network access</td>
      <td>NAT (default)</td>
      <td>transparent?</td>
      <td>transparent?</td>
	  <td></td>
</tr>

<tr>
    <td>Host's device access</td>
    <td></td>
    <td></td>
    <td>/dev, /sys and /proc of host show up inside container</td>
	<td></td>
</tr>


<tr>
    <td>Host's file system access</td>
    <td>Start container with a special mapping (loopback mount inside the container?), writable as root</td>
    <td>Singularity app run as a user process, therefore it has access to all of host's fs and devices that any user process have access to, including Lustre, GPFS, IB? etc?  Need to setup device mapping?
    </td>
    <td>Start shifter with volume mapping, done using loop dev.
    </td>
    <td></td>	
</tr>


<tr>
    <td>Adopters</td>
    <td>Like wildfire</td>
    <td>UC Berkeley, Stanford, TACC, SDSC, GSI, HPC-UGent, Perdue, UFL, NIH, etc </td>
    <td>NeRSC, VLSCI, CSCS, CERN, etc</td>
	<td></td>
</tr>


<tr>
    <td>Sample User Commands</td>
    <td></td>
    <td>
      singularity build example.sspec # build an app using a spec file <BR />
      <TT>
      ./example.sapp    # execute the singularity app <BR />
      </TT>
    </td>
    <td>
      <TT>
      module load shifter <BR />
      shiftering pull docker:python:3.5  # pull docker image <BR />   
      shifterimg images # list images <BR />
      shifter --image=python:3.5 python  # execute a container app <BR />
      module load slurm <BR />
      sbatch --image=docker:python:3.5 shifter python # run as job <BR />
      </TT>
      <!--shiftering pull docker:ubuntu:14.04 <BR />   -->
      <!-- # pull docker image, recommend specific version rather than using :latest  -->
      <!--shifter - -image=r-base:latest R  # execute a container app <BR />-->
      <!--
      salloc -n1 - -image=docker:python:3.5.1
      srun shifter ./myscript.py              # 
      -->
    </td>
  <td></td>
</tr>

<tr>
  <td>Unix pipes</td>
  <td>
    output of container captured by pipe.  eg: <BR />
    <TT>docker run centos:6 ls /etc | wc</TT> <BR />
    However, docker won't take standard input,  at least not for 1.5-1.  The follwing does not work as one might expect: <BR />
    <TT>echo 'cat("Hello world\n")' | docker run r-base:latest R --no-save</TT> <BR />
    <!-- echo "print hello world" | docker run python:latest python <BR /> -->
  </td>
  <td>
    can daisy chain singularity apps like regular unix commands.  eg <BR />
    <TT>./echo.sapp | ./grep.sapp</TT>  <BR />
  </td>
  <td>
    Shifter will capture standard input as well inside an sbatch script: <BR />
    <TT>echo 'cat("Hello world\n")' | shifter R --no-save</TT>
  </td>
  <td></td>
</tr>


<tr>
    <td>Misc</td>
    <td></td>
    <td>
    Singularity app can run outside HPC, without any job scheduler.  It can serve as a container for app portability outside the HPC world, and since a single file encompass the whole container, this maybe advantageous for sharing, portability and archive.  <BR />
    The use of singularity would require compiling all apps into the Singularity container, spec files would need to be written.  I hear they are looking to adopt Docker and/or RKT specfile to minimize this burden.  <BR />
    In the future, maybe NeRSC's shifter could  run singularity app as well.  <BR />
    </td>
    <td>
    Shifter container/app can run as stand alone outside HPC scheduler.  This is certainly useful for testing and development.  However, if one isn't trying to utilize container in HPC, maybe there is not much point in converting docker images to shifter images.  <BR />
    Shifter works by pulling the large number of existing containers.  Docker isn't needed inside the HPC, some gateway location can be used for Shifter to pull docker images and store converted image in a location accessible cluster-wide, eg /scratch.  See <A HREF="https://tin6150.github.io/psg/blogger_container_hpc.html#shifter_workflow">shifter workflow</A> below for more details. <BR />
    </td>
  <td></td>
</tr>

<!--
<tr>
    <td>Topic</td>
    <td></td>
    <td></td>
    <td></td>
	<td></td>
</tr>
-->


</tbody>
</table>

<!-- ################################################################## -->
<!-- end of table section -->
<!-- ################################################################## -->



<BR><BR>

<A NAME="workflow"></A>
<A NAME="shifter_workflow"></A>
<H3> Shifter Workflow</H3>
As per <A HREF="http://www.slideshare.net/insideHPC/shifter-containers-in-hpc-environments">CSCS/ETH slide share</A>, based on Shifter 15.12.0.
<br/><br/>

<IMG SRC="https://tin6150.github.io/psg/fig/shifter_flow1.png"></IMG><BR />
<IMG SRC="https://tin6150.github.io/psg/fig/shifter_flow2.png"></IMG><BR />
<IMG SRC="https://tin6150.github.io/psg/fig/shifter_flow3.png"></IMG><BR />


<!-- ################################################################## -->
<!-- start of reference/reading section -->
<!-- ################################################################## -->


<BR><BR>

<H3>Readings for Containers in HPC</H3>
<UL>
<LI> <A HREF="https://medium.com/@ople/containers-meet-hpc-2aab7aa2d54a#.b23izdadz">Container meets HPC</A> blog.
<LI> <A HREF=""></A>
</UL>

<H3>Readings for Singularity</H3>
<UL>
<LI> <A HREF="http://www.admin-magazine.com/HPC/Articles/Singularity-A-Container-for-HPC">Admin mag</A> Setup and example run with singularity.
<LI> <A HREF="https://www.hpcwire.com/2016/10/20/singularity-containers-easing-scientific-computing/">HPC Wire</A> Q+A with main Singularity author Gregory Kurtzer
<LI> <A HREF="http://singularity.lbl.gov/contributing-docs">Singularity doc</A>
</UL>


<H3>Readings for Shifter</H3>

<UL>
<LI> <A HREF="https://www.nersc.gov/research-and-development/user-defined-images/">User defined images</A> NeRSC documentation.
<LI> <A HREF="http://www.slideshare.net/insideHPC/shifter-containers-in-hpc-environments">Shifter use cases</A> slide share from CSCS/ETH Zurich
<LI> <A HREF="http://www.slideshare.net/OlliPekkaLehto/containers-and-hpc">Container and HPC</A> slide share. 
<LI> <A HREF="https://www.vlsci.org.au/documentation/running_jobs/shifter/">Shifter vs Docker</A> documentation at VLSCI, with step-by-step instructions on how to obtain and build a shifter app in a SLURM cluster.
<LI> <A HREF="https://github.com/NERSC/shifter/blob/master/doc/mpi/mpich_abi.rst">Using MPI in Shifter</A>
<LI> <A HREF=""></A>
</UL>

<H3>Readings for UGE </H3>

<UL>
<LI> <A HREF="http://www.univa.com/resources/files/gridengine_container_edition.pdf">Univa Grid Engine Container Edition</A> pdf.
<LI>
</UL>



</div>    <!-- ends blogger req tag started as <div dir="ltr" style="text-align: left;" trbidi="on"> -->

<!-- ################################################################## -->
<!-- JavaScript for G+ button -->
<!-- ################################################################## -->


      <div id="google-plus">      
      <!-- Place this tag where you want the +1 button to render -->
      <g:plusone></g:plusone>
      &lt;-- Please click if you found this site useful ;-) 
      <!--  Place this tag after the last plusone tag -->
      <script type="text/javascript">
        (function() {
          var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
          po.src = 'https://apis.google.com/js/plusone.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
        })();
      </script>
      </div> <!-- #G+ -->



</BODY>
</HTML>
